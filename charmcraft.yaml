# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
# This file configures Charmcraft.
# See https://canonical-charmcraft.readthedocs-hosted.com/stable/howto/manage-charmcraft/
# for guidance.

name: falco
type: charm
title: Falco Operator
summary: Juju charmed operator for Falco
description: |
  The Falco Operator is a Juju charmed operator that simplifies the deployment
  and management of Falco, an open-source runtime security tool for physical and
  virtual machines. The operator automates tasks such as installation, configuration,
  and updates of Falco instances, making it easier for users to secure their systems.

links:
  contact: https://launchpad.net/~canonical-is-devops
  documentation: https://charmhub.io/falco
  issues: https://github.com/canonical/falco-operator/issues
  source: https://github.com/canonical/falco-operator

platforms:
  ubuntu@24.04:amd64:

subordinate: true

parts:
  charm:
    source: .
    plugin: uv
    build-snaps:
      - astral-uv
  falco:
    plugin: nil
    override-build: |
      # Use default craft build environment
      craftctl default

      # Set Falco version
      # renovate: depName=canonical/falco-operator
      VERSION=0.42.1
      # Determine architecture
      ARCH="$(uname -m)"
      # Github release URL for Falco. The tarball is created in the build and release falco workflow:
      # https//github.com/canonical/falco-operator/blob/main/.github/workflows/build_falco.yaml
      # https//github.com/canonical/falco-operator/blob/main/.github/workflows/release_falco.yaml
      DOWNLOAD_URL="https://github.com/canonical/falco-operator/releases/download/falco\/$VERSION/falco-$VERSION-$ARCH.tar.gz"

      # Install falco
      curl -s -L -o $CRAFT_PART_SRC/falco-$VERSION-$ARCH.tar.gz $DOWNLOAD_URL
      tar -xvf $CRAFT_PART_SRC/falco-$VERSION-$ARCH.tar.gz -C $CRAFT_PART_BUILD/
      cp -r $CRAFT_PART_BUILD/{etc,usr} $CRAFT_PART_INSTALL/
    organize:
      "*": falco/
    stage:
      - falco/usr/bin/falco
      - falco/usr/share/falco/
      - falco/etc/falco/default_rules/

config:
  options:
    setting-repo:
      type: string
      default: ""
      description: |
        A remote git repository for custom falco rules and falco configuration to customize falco operator.
        The format of the config option must be `<schema>://<user>@<host>/<path>[?ref=<branch>][&sub_path=<sub_path>]`.
        For example,
        * `git+ssh://git@github.com/canoincal/falco-operator.git`.
        * `git+ssh://git@github.com/canoincal/falco-operator.git?ref=main`.
        * `git+ssh://git@github.com/canoincal/falco-operator.git?ref=production&sub_path=/src/manifests`.

        The repository should have the following structure

        settting-repo/sub_path
        ├── config.override.d/
        │   ├── a.yaml
        │   └── b.yaml
        └── rules.d/
            ├── a.yaml
            └── b.yaml

        If the repository is not public, SSH key should be provided via secret, and the secret ID should be set in
        `setting-repo-ssh-key-id`.
    setting-repo-ssh-key-id:
      type: secret
      description: |
        The Juju secret ID corresponding to the private key for SSH authentication to the git repository. The secret
        should contain a single key, `value`, which maps to the actual SSH key. To create the secret, run the following
        command. and use the secret ID output to configure this option.

        `juju add-secret setting-repo-ssh-key value=<ssh-key> && juju grant-secret setting-repo-ssh-key falco`

requires:
  general-info:
    interface: juju-info
    scope: container
